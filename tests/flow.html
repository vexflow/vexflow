<!doctype html>
<html>
  <!-- 
    This page does not work with Safari 13.0.2 due to
    - top level await
    - nullish coalescing operator
   -->
  <head>
    <title>VexFlow Tests</title>
    <!-- fonts.css defines the music fonts via @font-face rules. -->
    <link rel="stylesheet" href="fonts.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="qunit/qunit.css" />
    <script src="qunit/qunit.js"></script>
    <meta charset="UTF-8" />
    <style>
      body {
        font-family: Arial, sans-serif;
        font-size: 12px;
        color: black;
        margin: 0px;
        padding: 0px;
        height: 80%;
      }

      a.button {
        color: green;
        background: #bfb;
        text-decoration: none;
        padding: 5px;
        margin: 2px;
        border: 5px solid #aea;
      }

      div#error {
        width: 60%;
        padding: 10px;
        color: red;
        background: #faa;
        border: 15px solid #d99;
      }

      div.testcanvas {
        font-size: 18px;
        color: #554;
      }

      div.testcanvas .vex-tabdiv {
        background: white;
      }

      div.testcanvas .name {
        font-size: 18px;
        color: #447;
      }

      p.vf-footer {
        font-size: 14px;
      }
    </style>
  </head>
  <body>
    <div style="text-align: center">
      <div id="qunit"></div>
      <div id="qunit-fixture"></div>
      <div>
        <h2>[ <a href="https://vexflow.com">Home</a> ] [ <a href="https://github.com/vexflow/vexflow">GitHub</a> ]</h2>
        <h3>
          See the: <a id="vex-src" target="_blank"></a>. Don't forget to run the
          <a href="https://github.com/0xfe/vexflow/wiki/Visual-Regression-Tests">Visual Regression Tests</a>!
        </h3>
      </div>
      <p>&nbsp;</p>
      <p>&nbsp;</p>
      <p class="vf-footer">
        [ <a href="https://vexflow.com">Home</a> ] [ <a href="https://github.com/vexflow/vexflow">GitHub</a> ]
      </p>
    </div>
    <div id="font-preload">
      <!-- Preload all fonts and styles for testing. The empty bold and italic tags below are for loading the different font weights/styles. -->
      <span style="font-family: Academico"><b></b></span>
      <span style="font-family: Bravura"></span>
      <span style="font-family: Edwin"
        ><b></b><i></i><b><i></i></b
      ></span>
      <span style="font-family: Finale Ash"></span>
      <span style="font-family: Finale Broadway"></span>
      <span style="font-family: Finale Jazz"></span>
      <span style="font-family: Finale Maestro"></span>
      <span style="font-family: GonvilleSmufl"></span>
      <span style="font-family: Gootville"></span>
      <span style="font-family: Leland"></span>
      <span style="font-family: MuseJazz"></span>
      <span style="font-family: Petaluma"></span>
      <span style="font-family: Petaluma Script"></span>
      <span style="font-family: Roboto Slab"
        ><span style="font-weight: 500"></span><span style="font-weight: 700"></span
      ></span>
    </div>
    <script type="module">
      QUnit.config.autostart = false;

      function loadScript(url) {
        return new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.onload = resolve;
          script.onerror = reject;
          script.src = url;
          document.getElementsByTagName('head')[0].appendChild(script);
        });
      }

      // Support a query param to choose which VexFlow version to load.
      // ver=(build/cjs | reference | releases/4.0.0 | etc...)
      // If omitted, `ver` defaults to 'build/cjs'.
      // ver can also specify a version hosted on unpkg.com / jsdelivr.com:
      // ver=unpkg@3.0.9     => https://unpkg.com/vexflow@3.0.9/releases/vexflow-debug.js
      // ver=unpkg@1.2.77    => https://unpkg.com/vexflow@1.2.77/releases/vexflow-debug.js
      // ver=jsdelivr@4.0.0  => https://cdn.jsdelivr.net/npm/vexflow@4.0.0/build/vexflow-debug.js
      // ver=jsdelivr@1.2.90 => https://cdn.jsdelivr.net/npm/vexflow@1.2.90/releases/vexflow-debug.js
      const queryParams = new URLSearchParams(location.search);
      // When flow.html is hosted on unpkg.com, the query string is not available.
      // Allow the user to specify some params via the # fragment identifier.
      let hashParams;
      if (location.hash.length > 0) {
        hashParams = new URLSearchParams(location.hash.substr(1));
      }
      const ver = queryParams.get('ver') ?? hashParams?.get('ver') ?? 'build/cjs';
      const useESM = queryParams.get('esm') === 'true' || hashParams?.get('esm') === 'true';

      let vexURL;
      let vexPlusTestsURL;

      // Determine if we are loading VexFlow from a CDN.
      let cdnURLPath;
      if (ver.includes('unpkg')) {
        cdnURLPath = 'https://unpkg.com/';
      } else if (ver.includes('jsdelivr')) {
        cdnURLPath = 'https://cdn.jsdelivr.net/npm/';
      }
      // If we are loading from a CDN, build the URLs.
      if (typeof cdnURLPath !== 'undefined') {
        // We only support version 4 or newer.
        const version = ver.split('@')[1];
        vexURL = `${cdnURLPath}vexflow@${version}/build/vexflow-debug.js`;
        vexPlusTestsURL = `${cdnURLPath}vexflow@${version}/build/vexflow-debug-with-tests.js`;
      } else {
        // We are NOT loading from a CDN.
        // We are loading from the local filesystem (vexflow/build/ | vexflow/reference | vexflow/releases/).
        const path = ver;
        // TODO RONYEH: We need to consider the cjs/ and esm/ directories.
        vexURL = '../' + path + '/vexflow-debug.js';
        vexPlusTestsURL = '../' + path + '/vexflow-debug-with-tests.js';
      }

      // Display which VexFlow version we loaded.
      const srcLink = document.getElementById('vex-src');
      srcLink.href = vexURL;
      srcLink.innerText = `VexFlow Source [${ver}]`;

      let loadVexFlow;
      const isFileProtocol = location.protocol === 'file:';
      if (useESM && isFileProtocol) {
        prompt(
          'ES modules require a web server for testing!\n\nTry `npx http-server` and browse to http://127.0.0.1:8080/tests/flow.html?esm=true\n\nWe will fall back to CJS for now.',
          'npx http-server'
        );
      }
      if (useESM && !isFileProtocol) {
        console.log('LOADING ESM');
        // ESM version only works if flow.html is accessed from a web server
        // (e.g., `npx http-server` and browse to http://127.0.0.1:8080/tests/flow.html).
        loadVexFlow = async () => {
          const module = await import('../build/esm/entry/vexflow-debug-with-tests.js');
          window.Vex = module.Vex;
          return Vex.Flow;
        };
      } else {
        console.log('LOADING CJS');
        // When loading version >= 4.0.0, only load vexflow-debug-with-tests.js
        loadVexFlow = async () => {
          await loadScript(vexPlusTestsURL);
          return Vex.Flow;
        };
      }

      // Only proceed after all fonts have loaded.
      const fontFaceSet = await document.fonts.ready;

      // Show font loading status in the console.
      const fontFaces = [...fontFaceSet];
      for (const fontFace of fontFaces) {
        const fontInfo = fontFace.family + ' / ' + fontFace.weight + ' / ' + fontFace.style;
        if (fontFace.status === 'loaded') {
          console.log(fontInfo + ' loaded!');
        } else if (fontFace.status === 'unloaded') {
          console.warn('*** ' + fontInfo + ' IS NOT LOADED! ***');
        } else if (fontFace.status === 'error') {
          console.error(fontInfo + ' ERROR');
        } else {
          console.log(fontInfo + ' has status: ' + fontFace.status);
        }
      }

      const VF = await loadVexFlow();

      // If you did not load the fonts via the div#font-preload above, you can load them with this API:
      // await VF.loadFonts(); // Load all web fonts that VexFlow knows about (Font.WEB_FONT_FILES).
      // await VF.loadFonts('Bravura'); // Load only the specified fonts.

      // Optionally specify the QUnit module or filter in the fragment identifier.
      if (hashParams) {
        if (hashParams.has('module')) {
          QUnit.urlParams.module = hashParams.get('module');
        }
        if (hashParams.has('filter')) {
          QUnit.config.filter = hashParams.get('filter');
        }
      }

      // Show only failed tests.
      QUnit.config.hidepassed = true;
      QUnit.config.noglobals = true;
      VF.Test.run();
      QUnit.start();
    </script>
  </body>
</html>
